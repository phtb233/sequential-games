var cells=[],$puzzle,X="X",O="O",whoseTurn,$whoseTurn,moves=[],turnSwitch,init,getOptimalPlay,checkWin,reset,noughtOrCross,playerScore,opponentScore,$playerScore,$opponentScore,addPoint,onError,puzzleMouseOverHandler,$tick,puzzleMouseOutHandler,$puzzle_wrapper,multiplayer,$cover,showMessageBox,$puzzle_main,$messageBox,otherPlayer,game,emDivisor;game="connect3";multiplayer=false;checkWin=function(player){fb=cells.map(function(c){return c.filledBy});return fb[0]===player&&fb[1]===player&&fb[2]===player||fb[3]===player&&fb[4]===player&&fb[5]===player||fb[6]===player&&fb[7]===player&&fb[8]===player||fb[0]===player&&fb[3]===player&&fb[6]===player||fb[1]===player&&fb[4]===player&&fb[7]===player||fb[2]===player&&fb[5]===player&&fb[8]===player||fb[2]===player&&fb[4]===player&&fb[6]===player||fb[0]===player&&fb[4]===player&&fb[8]===player};init=function(){playerScore=opponentScore=0;$tick=$("<div>").addClass("tick-container").append("<span>").addClass("tick X");$puzzle_main=$("#puzzle-main");$playerScore=$("#player-1-info .score");$opponentScore=$("#player-2-info .score");$puzzle=$("#puzzle");$puzzle_wrapper=$("#puzzle-wrapper");$whoseTurn=$("#whoseTurn");$puzzle.find(".cell").each(function(index){cell={"filledBy":"","jq":$(this)};cells.push(cell)});$puzzle.bind("click",puzzleClickHandler);$puzzle.bind("mouseover",puzzleMouseOverHandler);$puzzle.bind("mouseout",puzzleMouseOutHandler);turnSwitch(X)};reset=function(startingPlayer){$puzzle.unbind();$(".piece").remove();$tick.remove();cells.forEach(function(cell){cell.filledBy="";cell.jq.children(".hole").removeClass("X O")});moves=[];turnSwitch(startingPlayer)};puzzleClickHandler=function(e){if(whoseTurn===O)return;var $thisCell,cellIndex,columnIndex,cell,col;$thisCell=$(e.target);if(!$thisCell.hasClass("cell")){var $cell=$thisCell.parents(".cell");if($cell.length){$thisCell=$cell}else return};cellIndex=$thisCell.index();columnIndex=cellIndex%3;col=getColumn(cellIndex);if(col.length<3)takeTurn(X,columnIndex);return false};puzzleMouseOverHandler=function(e){if(whoseTurn===O)return;var $thisCell,cellIndex,columnIndex,cell,col;$thisCell=$(e.target);if(!$thisCell.hasClass("cell")){var $cell=$thisCell.parents(".cell");if($cell.length){$thisCell=$cell}else return};cellIndex=$thisCell.index();columnIndex=cellIndex%3;col=getColumn(cellIndex);if(col.length<3){$puzzle_wrapper.prepend($tick);puzzleOffset=($puzzle.width()/3)*(columnIndex+1);tickMid=$tick.width();$tick.css("left",(puzzleOffset-tickMid-3-$thisCell.width()/2)/emDivisor()+"em");$tick.css("top","-20%")};return false};emDivisor=function(){var fontSize=$(document.body).css("font-size");return parseFloat(fontSize)};puzzleMouseOutHandler=function(e){$tick.remove()};getColumn=function(cell){return cells.filter(function(elem,index,array){return(index%3===cell%3)&&elem.filledBy!==""})};addPoint=function(player){if(player===X){playerScore++;$playerScore.text(playerScore)}else{opponentScore++;$opponentScore.text(opponentScore)}};takeTurn=function(player,move){var col,len,index,cell,$cell,$hole,$piece,op;if(whoseTurn!==player)throw Error("Turn taken by the wrong player.");op=otherPlayer(player);col=getColumn(move);len=col.length;index=(2-len)*3+move;cell=cells[index];$cell=cell.jq;if(cell.filledBy!=="")throw Error("move taken");cell.filledBy=player;$hole=$cell.children(".hole");$piece=$hole.clone(false,true).addClass("piece "+player);var sz=(($hole.width()+2)/emDivisor())+"em",lf=(($hole.position().left)/emDivisor())+"em";$piece.css({"height":sz,"width":sz,"left":lf});$puzzle_wrapper.append($piece);$piece.css("top","-4em");$piece.css("top",(($hole.position().top)/emDivisor())+"em");$cell.children(".hole").addClass(player);moves.push(move);if(multiplayer&&player===X)$(document).trigger("sendMove",[move]);if(checkWin(player)){addPoint(player);showMessageBox("win",player);return};if(moves.length>=9){showMessageBox("draw",player)}else turnSwitch(op)};turnSwitch=function(player){switch(player){case X:whoseTurn=X;$whoseTurn.text("It's your turn.");$puzzle.bind("click",puzzleClickHandler);$puzzle.bind("mouseover",puzzleMouseOverHandler);$puzzle.bind("mouseout",puzzleMouseOutHandler);break;case O:whoseTurn=O;$whoseTurn.text("It's your opponent's turn.");$puzzle.unbind();$tick.remove();if(multiplayer){}else getOptimalPlay();break;default:throw Error("whoseTurn is undefined")}};onError=function(){console.log("random! response took too long.");var allMoves=[0,1,2,0,1,2,0,1,2],possible=allMoves.filter(function(e,i,a){return moves.indexOf(e)===-1}),randomIndex=Math.floor(Math.random()*(possible.length));takeTurn(O,possible[randomIndex])};showMessageBox=function(drawOrWin,player){var $message,$button,wonOrLost;$puzzle.unbind("click",puzzleClickHandler);$cover=$("<div id=\"cover\">");$cover.css("opacity",0.7);$messageBox=$("<div id=\"messageBox\">");$container=$("<div>");$message=$("<p>");wonOrLost=player===X?"won":"lost";if(drawOrWin==="draw"){$message.text("It's a draw.")}else if(drawOrWin==="win"){if(!player)throw Error('showMessageBox: winning player was not specified.');$message.text("You have "+wonOrLost+" the game.")}else throw Error("showMessageBox: wrong arguments.");$button=$("<button>");$button.text("OK");$button.on("click",function(e){$cover.remove();$messageBox.remove();reset(otherPlayer(player))});setTimeout(function(){$puzzle_main.append($cover);$puzzle_main.append($messageBox);$messageBox.append($container);$container.append($message);$container.append($button)},2000)};otherPlayer=function(player){if(player===X)return O;return X};getOptimalPlay=function(){jQuery.ajax({type:"POST",url:"http://localhost:3000/connect3",data:JSON.stringify(moves),dataType:"json",success:function(data){takeTurn(O,data)},timeout:10000,error:onError})};init();(function($){var $chat,$output,$input,$button,src,$newMessage,sendMessage,isLoggedIn,initChat,initLogin,$username,$login,$message,myId,oppId,oppName,myName,$globe,searchForOpponents,onAddedToLobby,searchTimer,addMessage,$playerDetails,$opponentDetails,instructions,quitMultiplayer,startSearchHandler,quitMultiplayerHandler,cancelSearch,colours,myColour,oppColour,assignColours,trackDisconnect,createSource,resetScores,$matchesCount,$lobbyCount,$connectionCounts;$chat=$('#hident2');$globe=$("#globe");$output=$('#hident3');oppId=0;colours=["#B32","#2B3","#32B","#A73","#BB4","#C4A","#444"];initLogin=function(){var checkUsername;$username=$('#hident6');$login=$('#hident7');$message=$('#hident8');$notice=$('#hident9');login=function(e){if(validUsername()){var username=$username.val();$.ajax({type:"POST",url:"http://localhost:3000/chat/uname",data:{"username":username,"game":game},success:success,error:error});myName=username};return false};$username.bind("keyup",function(e){if(e.which===13){login(e);return false}});$login.bind("click",login);validUsername=function(){var text=$username.val(),valid=false;if(text.search(/[^A-Za-z ]/)!==-1){$message.text("There are invalid characters in your username.")}else if(text.length<3||text.length>20){$message.text("Your username must be between 3 and 20 letters.")}else valid=true;return valid};success=function(data){myId=data;$username.remove();$login.remove();$message.remove();$notice.remove();initChat()};error=function(xhr,code){$message.text('There was an error sending your username to the server.')}};initChat=function(){trackDisconnect();instructions=' You are currently playing the CPU. To play with others, click the search button.';$input=$("<textarea>");$input.attr({"id":"hident4","placeholder":" >"});$button=$("<button>");$button.attr("id","hident5");$button.text("Send");$globe.removeAttr("disabled");$globe.on("click",startSearchHandler);assignColours(colours);$chat.append($input);$chat.append($button);$playerDetails=$("#player-1-info");$opponentDetails=$("#player-2-info");$playerDetails.children(".name").text(myName);$connectionCounts=$("#connect");$lobbyCount=$("#lobby").children("span");$matchesCount=$("#matches").children("span");addMessage("Welcome, "+myName+"."+instructions);$(document).on("sendMove",function(e,move){$.ajax({type:"POST",data:{"id":myId,"move":move,"game":game},url:"http://localhost:3000/chat/taketurn",success:function(data){},error:function(a,code){addError('There was a problem while sending your move to the server.');quitMultiplayer()}})});$input.on("keypress",function(e){if(e.which===13){sendMessage();return false}});$button.on("click",function(e){sendMessage();return false});sendMessage=function(){var message=$input.val();$input.val("");addMessage(myName+" : "+message,myColour);if(!multiplayer){addMessage("You're talking to yourself")}else $.ajax({type:"POST",data:{"message":message,"from":myName,"to":oppId},url:"http://localhost:3000/chat/send",success:function(data){},error:function(data,code){addError('There was a problem sending your message to the server.\nCode : '+code)}})};onAddedToLobby=function(){var secs=2;searchTimer=setInterval(searchForOpponents,secs*1000);searchTimeout=setTimeout(cancelSearch,7*1000)};searchForOpponents=function(){$.ajax({type:"POST",url:"http://localhost:3000/chat/search",data:{id:myId,name:myName,"game":game},error:function(data,code){addError('There was a problem while searching for opponents.\nCode : '+code)}})}};quitMultiplayer=function(){if(src)src.close();src=null;addMessage("You are now playing the CPU");multiplayer=false;reset(X);oppId=null;oppName=null;$opponentDetails.children(".name").text("CPU");resetScores();$globe.text("Search");$globe.on("click",startSearchHandler);$matchesCount.text("n/a");$lobbyCount.text("n/a")};addMessage=function(message,colour="#777"){$newMessage=$("<p>");$newMessage.attr("style","color : "+colour);$newMessage.text(message);$output.append($newMessage);$output.scrollTop($output.get(0).scrollHeight)};addError=function(message){addMessage(message,"#F44")};startSearchHandler=function(e){if(!src)src=createSource();addMessage("Searching for opponents...");$globe.off("click");$globe.text("Searching");$globe.attr("disabled","");$.ajax({type:"POST",data:{id:myId,name:myName,"game":game},url:"http://localhost:3000/chat/lobby",success:onAddedToLobby,error:function(xhr,code){addError("Failed to join the lobby.");quitMultiplayer()}})};quitMultiplayerHandler=function(e){$globe.off("click");$.ajax({type:"POST",data:{"id":myId,"name":myName,"game":game},url:"http://localhost:3000/chat/close",error:function(a,code){addError("There was a problem closing the match.");quitMultiplayer()}});return false};cancelSearch=function(){addMessage("No opponents were found. Stopping search.");clearInterval(searchTimer);clearTimeout(searchTimeout);$globe.text("Search");$globe.removeAttr("disabled");$globe.on("click",startSearchHandler);$.ajax({type:"POST",data:{"id":myId,"name":myName,"game":game},url:"http://localhost:3000/chat/stopSearch",error:function(a,code){addError("Failed to exit lobby");quitMultiplayer()}})};assignColours=function(c){var index=Math.round(Math.random()*(c.length-1));myColour=c[index];c.splice(index,1);index=Math.round(Math.random()*(c.length-1));oppColour=c[index]};trackDisconnect=function(){$.ajax({type:"POST",url:"http://localhost:3000/chat/track",data:{id:myId,name:myName,"game":game}})};createSource=function(){var src;src=new EventSource("http://localhost:3000/chat/recv");src.addEventListener(myId+"error",function(e){addError(e.data);quitMultiplayer()},false);src.addEventListener(myId+"message",function(e){addMessage(e.data,oppColour)},false);src.addEventListener(myId+"match",function(e){var data=JSON.parse(e.data);oppId=data.oppId;oppName=data.oppName;resetScores();$opponentDetails.children(".name").text(oppName);addMessage("You are now playing with "+oppName);clearInterval(searchTimer);clearTimeout(searchTimeout);multiplayer=true;$globe.text("Close");$globe.removeAttr("disabled");$globe.on("click",quitMultiplayerHandler);if(data.player===X){reset(X)}else if(data.player===O){reset(O)}else;},false);src.addEventListener(myId+"move",function(e){addMessage(oppName+" takes their turn");takeTurn(O,parseInt(e.data))},false);src.addEventListener(myId+"close",function(e){addMessage(e.data);quitMultiplayer()},false);src.addEventListener("matchCount",function(e){$matchesCount.text(parseInt(e.data)*2)},false);src.addEventListener("lobbyCount",function(e){$lobbyCount.text(e.data)},false);return src};resetScores=function(){$opponentDetails.children(".score").text(0);$playerDetails.children(".score").text(0);opponentScore=playerScore=0};initLogin()})(jQuery)